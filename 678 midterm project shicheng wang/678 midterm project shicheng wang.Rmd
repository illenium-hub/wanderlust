---
title: "NBA players' ability analysis"
author: "678 midterm project by Shicheng Wang"
date: "11/1/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
###install packages
knitr::opts_chunk$set(echo = TRUE,out.width="0.9\\linewidth",dev="png",fig.align  = 'center')
pacman::p_load(
ggplot2,
knitr,
arm,
data.table,
foreign,
gridExtra,
car,
stringr,
rstan,
rstanarm,
tidyverse,
dplyr,
gridExtra
)
```


# 1.Abstract
This is a statistical analysis report about NBA situation. The aim of this report is to develop series of methods to measure the comprehensive strengthes of players in NBA union and trying to figure out how each kind of player's abilities could influence his shooting results in the small ball era. Additionally, the project has also analyzed the strategies and preferences of players. Specifically, EDA(Exploratory Data Analysis) and modeling are involved in this report. Overall, readers will get the general idea about how various elements influence players' shooting result.  

# 2.Introduction
## 2.1 Background
As NBA steps into a commercialize stage for almost 80 years, it have become a mature business alliance through decades' development, which has always been regarded as a focus and attracting bunches of capitals overseas. It is acknowledged that the players' performances is straightly related to the ratings and could determine the future of a team and related industries, making it is meaningful to conduct a depth analysis for these players' shooting ability.   
More importantly, NBA has experienced a huge change since 2014-2015 season. It could be attributed to the rise of three-point shooters leading by Curry and Tompson. Along with Golden State Warriors win the NBA championship finally,
it has initiated a new stage for NBA. That is to say, NBA has completed the transformation from old times (Tactical arrangement dominated by tall players inside the three-point line) to small ball era (Dominated by the three points shots outside the line). Hence, player's scoring choice would change since then.       

```{r out.width = "60%", fig.align = "center", echo=FALSE , message=FALSE, warning=FALSE}
knitr::include_graphics("/Applications/BU/BU/678 Applied Statistical Modeling/MA678 midterm project/678 midterm project shicheng wang/picture/small.jpg")
```

<center>
<img src="/Applications/BU/BU/678 Applied Statistical Modeling/MA678 midterm project/678 midterm project shicheng wang/picture/small.jpg" width="5" height="5" />


## 2.2 Data sources
There are overall three datasets included in the report. For the EDA part, I will use NBA League Averages(season) which contains averages statistics of all players in NBA in each year to get the general idea of players' condition in the whole association throughout 70 years. This dataset is collected in Basketball Reference. Besides, I also use NBA Season Data(player) for EDA part to analyze players' performance throughout 70 years, and this dataset is collected in Pro Basketball Statistics. The main dataset(da) i used to further analyze is NBA Shot Logs during 2014-2015 season, this dataset detailly record each player's performance at each time period in each game, and this is collected in Kaggle, while they are originally scraped from NBA's REST API. The following are websites of each dataset.  

* NBA League Averages - Totals: [link](https://www.basketball-reference.com/leagues/NBA_stats_totals.htmlm)  
* NBA Season Data: [link](http://www.nbastats.net/)  
* NBA Shot Logs during 2014-2015 season: [link](https://www.kaggle.com/dansbecker/nba-shot-logs)  

## 2.3 Research question
For the former part of EDA in this project, I would analyze how players' characteristics and how average skill level could change throughout 70 years based on the relavant database. Main research question of this project is to analyze how each players' series of charactistics could influence the actural shooting ability in each single game.  

# 3.Methodology  
## 3.1 Data process
* Data access
Importing three datasets.
```{r}
team <- read.csv("/Applications/BU/BU/678 Applied Statistical Modeling/MA678 midterm project/678 midterm project shicheng wang/data/NBA League Averages.csv")
player <- read.csv("/Applications/BU/BU/678 Applied Statistical Modeling/MA678 midterm project/678 midterm project shicheng wang/data/Seasons_Stats.csv")
data <- read.csv("/Applications/BU/BU/678 Applied Statistical Modeling/MA678 midterm project/678 midterm project shicheng wang/data/shot_logs.csv")
```

* Data organize
```{r,include=FALSE}
### team data 
season <- na.omit(team[1:42,c(2,4,5,6,8:32)])
dim(season)
### reserse order
season <- arrange(season,season$X.1)
season <- season[c(-42),c(1,2,4,6:9,21:23)]
### rename variables
season <- plyr::rename(season,c(X.1="year",X.3="age",X.5="weight",X.7="fg_per",X.8="fg_aver",X.9="3g",
                                X.10="3a",Shooting="fg%",X.22="3p%",X.23="ft%"))
### variables adjust
season$help = 1
season$year = as.factor(season$year)
season$age = as.factor(season$age)
season$year <- substr(season$year,3,4)
season$year <- factor(season$year, as.character(season$year))
season$`3g` = as.numeric(as.character(season$`3g`))
season$`3a` = as.numeric(as.character(season$`3a`))
season$`3p%`= as.numeric(as.character(season$`3p%`))
```
_For the season average dataset, clear the NA data in the beginning. Because the row are arranged from big to small, so i reverse the data order by year, then select the columns which are going to be analyzed in EDA part. In order to be easily understood, i rename the variables' name._        

```{r,include=FALSE}
### player data
player <- player[,c(1:6,11:13,35:40,53)]
players <- na.omit(player)
dim(player)
unique(players$Year)           # the new data contain all the players' comprehensive abilities form 2014-2016
### rename variable
players <- plyr::rename(players,c(X="number",Year="year",Player="player",Pos="position",Age="age",Tm="team",
                              TS.="trueshoot",X3PAr="3rate",FTr="ftrate",X3P="3goal",X3PA="3attempt",X3P.="3per",X2P="
                              2goal",X2PA="2attempt",X2P.="2per",PTS="point"))
```
_For NBA players dataset, drop out players whose data are incompelete. Then i get all players' dataset from 1980 to 2017. This dataset is used for analyzing player's preference and ability of shooting._        


For the main dataset, the data cleaning procession shows as below:   
* Step1: cleaning      
```{r,include=FALSE}
### clear NA data
data <- na.omit(data)          # lose almost 6000 rows
                               # new data contain all the players' comprehensive abilities form 2014-2016
### check the distribution of players' shooting range
number <- count(data,player_name) 

### drop players' data whose shooting under 200 times(based on the former histgram).
newdata <- merge(number,data)
data <- filter(newdata,n>=200) # lose about 10000 rows
```
     
```{r}
### players data amount
hist(number$n, density = 3, col = "skyblue", main  = "density = 3")       
```
_Firstly, clearing the NA value, then calculate how many rows does each player have, and draw a barplot based on each player's data amount. Notice that several players have less than 200 rows which could hinder modeling procession, so i drop these players._   

* Step2: adjustment  
```{r,warning=FALSE,message=FALSE}
### select useful column
data <- dplyr::select(data,-n)
da <- data[,c(1,4,5,6,7,8,10:15,18)]

### rename variables' names 
library(reshape)
da <- plyr::rename(da,c(player_name="name",LOCATION="location",W="winlose",FINAL_MARGIN="margin",SHOT_NUMBER="shotnumber",PERIOD="period",SHOT_CLOCK="shotclock",DRIBBLES="dribble",TOUCH_TIME="touch",SHOT_DIST="range",PTS_TYPE="type",SHOT_RESULT="result",CLOSE_DEF_DIST="defence"))

### adjust variables
da$location=as.numeric(da$location)-1   # 1 for home, 0 for away
da$winlose=as.numeric(da$winlose)-1     # 1 for win, 0 for lose
da$result=2-as.numeric(da$result)       # 1 for made, 0 for miss
da$type=as.numeric(da$type)
```
_After organizing the dataset well, I select specific information and rename the variable name. Additionally, i adjust variables' value which could be beneficial for later analysis._   

* Data overview
The head of shot log.
```{r,echo=FALSE}
knitr::kable(head(da), digits = 4, align = "c",
             caption = 'Overview of shot log',booktabs = TRUE)
```

Type variables's categories and overview.     
```{r,echo=FALSE}
kable(table(data$LOCATION))
kable(table(data$PERIOD))
kable(table(data$PTS_TYPE))
kable(table(data$SHOT_RESULT))
par(mfrow=c(2,2))
```
 
## 3.2 Variables interpretation
* The main data i use is named 'da', the following table shows variables interpretations that are included in the cleaned dataset. 

Variable Name              | Interpretation
-------------------------  | -----------------------------
name                       | player's name
location                   | game home or away
winlose                    | game win or lose
margin                     | game final margin
shotnumber                 | play's shooting number
period                     | player's shoot in which game period
shotclock                  | the rest attacking time when shooting
dribble                    | player's dribble times before shooting
touch                      | player's touching times before shooting
range                      | shooting distance from the board
type                       | 2 points shoot or 3 points shoot
defence                    | the defence player's distance from shooting player
result                     | goal or miss  

# 4.EDA visualization
## 4.1 Player's shooting average overyear
```{r,echo=FALSE}
### Weight
p1<-ggplot(season, aes(x=year, y=weight, group=help, width=3)) + geom_line(linetype='dashed',colour='#6600FF') +geom_point(size=2,colour='#6699CC',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  labs(title = "Weight")

### Field Goal Attempts Per Game
p2<-ggplot(season, aes(x=year, y=season$fg_per, group=help, width=3)) + geom_line(linetype='dashed',colour='#FFCCFF') +geom_point(size=2,colour='#FFCC00',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  scale_y_discrete(breaks=c(43,42.1,40.7,37,35,33.3,29.8,25.9,38.2,36.1))+
  labs(title = "Field Goal Attempts Per Game")

### Field Goal Percentage
p3<-ggplot(season, aes(x=year, y=season$`fg%`, group=help, width=3)) + geom_line(linetype='dashed',colour='#CC3333') +geom_point(size=2,colour='#993300',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  scale_y_discrete(breaks=c(0.279,0.284,0.34,0.37,0.395,0.415,0.433,0.459,0.466,0.48,0.486,0.437,0.449,0.454))+
  labs(title = "Field Goal Percentage")

### 3-Point Field Goals Per Game
p4<-ggplot(season, aes(x=year, y=season$`3g`, group=help, width=3)) + geom_line(linetype='dashed',colour='#660000') +geom_point(size=2,colour='#336600',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  labs(title = "3-Point Field Goals Per Game")

### 3-Point Field Goal Attempts Per Game
p5<-ggplot(season, aes(x=year, y=season$`3a`, group=help, width=3)) + geom_line(linetype='dashed',colour='#336600') +geom_point(size=2,colour='#0099CC',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  labs(title = "3-Point Field Goal Attempts Per Game")

### 3-Point Field Goal Percentage
p6<-ggplot(season, aes(x=year, y=season$`3p%`, group=help, width=3)) + geom_line(linetype='dashed',colour='#990000') +geom_point(size=2,colour='#996600',shape=20)+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_x_discrete(breaks=c(79,82,85,88,91,94,97,"00","03","06","09",12,15,18))+
  labs(title = "3-Point Field Goal Percentage")

gridExtra::grid.arrange(p1,p2,p3,p4,p5,p6,ncol = 3)
```
_For the weight aspect, we could see the weight requirement is incresing, while there is an obvious decrease in 2012, it can be ascribed to the fact that the center position has been dominated the whole union until 2012 and then comes the small ball era, which relies more on light and flexible players to shooting 3-point shots._     
_For the field goal condition, we could see it vibrate overyears and one characteristic is that the big drop 1990-2000, this is because players would like to concentrate more on defencing than offencing._     
_For 3-point field goals, there exists steady increase in recent 30 years and the growth rate increases since 2012 due to the small ball era._      

## 4.2 Distribution of players' 2-point and 3-point ability overyear
```{r,echo=FALSE}
### 2-Point Field Goal Attempts 
p7<-ggplot(players,aes(x=year,y=`2attempt`,group=year))+geom_boxplot(fill='#CC9966',outlier.colour="#CC6633", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "2-Point Field Goal Attempts")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")
### 3-Point Field Goal Attempts
p8<-ggplot(players,aes(x=year,y=`3attempt`,group=year))+geom_boxplot(fill='#FF9966',outlier.colour="#FF9933", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "3-Point Field Goal Attempts")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")
### 2-Point Field Goals
p9<-ggplot(players,aes(x=year,y=`
                              2goal`,group=year))+geom_boxplot(fill='#CC3333',outlier.colour="#CC3300", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "2-Point Field Goals")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")
### 3-Point Field Goals
p10<-ggplot(players,aes(x=year,y=`3goal`,group=year))+geom_boxplot(fill='#990066',outlier.colour="#990033", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "3-Point Field Goals")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")
### 2-Point Field Goal Percentage
p11<-ggplot(players,aes(x=year,y=`2per`,group=year))+geom_boxplot(fill='#663399',outlier.colour="#663333", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "2-Point Field Goal Percentage")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")
### 3-Point Field Goal Percentage
p12<-ggplot(players,aes(x=year,y=`3per`,group=year))+geom_boxplot(fill='#330099',outlier.colour="#330066", outlier.shape=18, outlier.size=1)+scale_fill_brewer(palette = "Set3")+labs(title = "3-Point Field Goal Percentage")+theme(plot.title = element_text(hjust = 0.5))+stat_summary(fun.y = "mean", geom = "point", shape = 16, size = 1, color = "white")

gridExtra::grid.arrange(p7,p8,p9,p10,p11,p12,ncol = 2)
```
_Of all the players in the NBA from 1980 to 2017, their shooting trends are obvious. In the comparasion between 2-point field goals and 3-point field goal, 2-point field goal attempts/goals have been decreasing while 3-point field goal attempts/goals have been increasing. In the meantime, the 2-point field goal percentage keep developing steady, while the 3-point shooting quality increases to an upper level._    

## 4.3 Shooting preference 2014-2015 season.
* shoot type preference: It is well acknowledged that 2014-2015 season could be regarded as the beginning of the small ball era,
```{r,echo=FALSE}
### range preference
ggplot(da, aes(x=range)) + 
    geom_histogram(aes(y=..density..),binwidth=.5,colour="#CC6666", fill="#FFCC99") +
    geom_density(alpha=.2, fill="#66CCFF")+
    geom_line(stat="density",colour="#990033")
```
_From the first plot we could see player's main scoring distance distribute located in 0-5 meters and 22-25 meters area which indicates players nowadays prefer layup, dunk or throw 3-point balls during the game_   
```{r,echo=FALSE}
### shotclock preference
ggplot(da, aes(x=shotclock)) + 
    geom_histogram(aes(y=..density..),binwidth=.5,colour="#663366", fill="#6699CC") +
    geom_density(alpha=.2, fill="#666699")+
    geom_line(stat="density",colour="#6600CC")
```
_From the second plot, we could see majority of players prefer more organized attacks, that is to say they are not willing to hurry up shoots or shot until the last second._   

## 4.4 How variables influence player's shoot result.    
```{r,echo=FALSE,message=FALSE}
### range and distance(result)
ggplot(da,aes(range, defence))+geom_point(aes(color=factor(result)))+
  geom_vline(xintercept=c(mean(da$range)),color="#CC3300")+
  geom_hline(yintercept=mean(da$defence),color="#339999")+
  geom_smooth(color="#330033",type=3)
```
_In this plot we can discover the relationships between defence and range categorized by result. It turn out that players could make more shots in 0-9 meters and 25 meters around range. As the range rise, the defence range could correspondlingly rise because defender believes it is difficult to make a shot at far range._  
```{r,echo=FALSE,message=FALSE}
### touch and dribble(result)
ggplot(da,aes(dribble, touch))+geom_point(aes(color=factor(result)))+
  geom_vline(xintercept=c(mean(da$dribble)),color="#CC3300")+
  geom_hline(yintercept=mean(da$touch),color="#339999")+
  geom_smooth(color="#330033",type=3)+ylim(-10,20)
```
_As we can see, if a players dribble more, they would exert more touching time. While, in this plot we could not see an obvious difference that more dirbbles and touch time could bring to higher hit rate._  

## 4.5 C-tree analysis 
```{r,echo=FALSE,message=FALSE}
library(party)
formula<-result~location+winlose+period+shotnumber+shotclock+dribble+touch+range+type+defence
dt<-ctree(formula,da,controls=ctree_control(minsplit=10,maxdepth=3))
plot(dt)
```
_From the C-tree, we could see the decisive relationship between variables, the shooting range large influence the other variables._   

## 4.6 Corelation Test
```{r,echo=FALSE}
shot <- da[,c(5:13)]
M = cor(shot,method = "spearman")
corrplot::corrplot(M,method = "ellipse")
```
_Corelation plot shows there exists obvious relationships ammong touch, dribbles, distance, range, shotclock, type, and shooting result._    


After i have done EDA, I believe the players shooting preference has changed so much in recent years that i decide to analyze how their shooting results are influenced by other factor.   
Based on NBA shot log dataset, I pick some of variables to build the model.  

# 5.Model analysis
## 5.1 General linear model
* Building model    
The first model i use is general linear model, cause output of the model is bineary distribution, I use the glm function to build model. Model shows below:  
```{r,message=FALSE}
model_1<-glm(result~location+shotclock+shotnumber+period+dribble+touch+range+defence+type+as.factor(name),family = binomial,da)
display(model_1)
```
_There are 242 players in my dataset, each player has their own constructed function._  

* Interpretation  
In this model, the majority of the coefficient are significant. Choose my favorite player called Damian Lillard, his predicting function shows below:       

$$logit(result)=0.01 + 0.04location +0.01shotclock+0.02dribble-0.06touch-0.07range+0.11defence+0.11type+0.1(player) $$
_In this model, the majority of the coefficient are significant. But the according to the binned residual plot, there 
exists an obvious pattern, and the outliers are pretty large, hence this model needs improvement._  

_Intercept: The log odds of shooting percetage of a player is 0.01 when he is playing away with no touch/dribble and no shoot intentation._  

_The coefficient of location: Gaming home would has 0.04 log odds of shooting percentage more than gaming away for players with all other variables the same._    

_The coefficient of type: Shooting 3-point field goal would has 0.11 log odds of shooting percentage more than shooting 2-point field goal with all other variables the same_  

_The coefficient of shotclock: With every 1 level increase in shotclock level, the expected log odds of shooting percentage for specific player would increase by 0.04 unit with all other variables the same._  

_The coefficient of dribble: With every 1 level increase in dribble level, the expected log odds of shooting percentage for specific player would increase by 0.02 unit with all other variables the same._  

_The coefficient of touch: With every 1 level increase in touch level, the expected log odds of shooting percentage for specific player would decrease by 0.06 unit with all other variables the same._  

_The coefficient of range: With every 1 level increase in range level, the expected log odds of shooting percentage for specific player would decrease by 0.07 unit with all other variables the same._  

_The coefficient of defence: With every 1 level increase in defence level, the expected log odds of shooting percentage for specific player would increase by 0.11 unit with all other variables the same._  

_The coefficient of player: With each player, his log odds of shooting percentage would corespond with their own coefficient in the model summary._  

* Model check
```{r}
binnedplot(predict(model_1,type="response"), residuals(model_1,type="response"))
```
_In this model, the majority of the coefficient are significant. But the according to the binned residual plot, there exists an obvious pattern(like a character V). What's more the outliers are pretty large, showing that this model does not fit very well. Hence this model needs improvement._   

## 5.2 Bayesian generlized linear model
The second model i construct is bayesian generlized linear model with proper transformation and interaction, model shows below:   
```{r}
model_2<-rstanarm::stan_glm(result ~         shotnumber+I(shotclock^2)+period+dribble+touch+touch*dribble+type*range+I(range^2)+I(defence^2),
                            family=binomial(),da,cores = 4)
summary(model_2)
```
_Using the binomial family for bayesian general linear model and do the MCMC diagnostics. From the summary, we can see the sample's mean/standard devation and the standard error. The next step to examine this model is to see the simulate y-output of this model_    

* Model check
```{r}
rstanarm::pp_check(model_2)
```
_The simulation result show the output of my model is quite corespond with the binomial observation which is 0 or 1, indicating the model fits quite well._  
_According to the EDA part and the formoer models, I found that there could exist interaction among variables. Moreover, different players could leads to different shooting range and defending strategies. So the next following model i will introduce is mutilevel model._  

## 5.3 Mutilevel model
### random intercept
```{r,message=FALSE,warning=FALSE}
### m1
m1<-glmer(result~location+shotnumber+period+shotclock+dribble+touch+type+range+defence+
            dribble*touch+type*range+(1|name), data=da,family = binomial(),REML = T)
```
_First model i apply is mutilevel level with random intercept. In this model, different player would has different intercept._  
```{r,message=FALSE}
### summary
summary(m1)
```
_I set players name as pooling principle, so i get nearly 250 groups. From summary of m1 we can see the most coefficients's p-value are quite small and they are significant, indicting the varibales could influence player's shooting result, there might exist mix effect in this model. From the result, we can see the variance is 0.01638, the random effect exists among different players. The AIC and BIC are 154521.8 and 154647.4. Additionally, there exists corelationships between these variables._    

```{r}
### check
pred1 = predict(m1,type = "link")
red1 = as.numeric(as.character(pred1))-da$result
com1 = data.frame(obs = da$result,pre = pred1) %>% pivot_longer(cols = 1:2,names_to = "type",values_to = "value")
red11 = sample(red1,4000)
### check visualization
car::qqPlot(red11)
plot(red11)+abline(h=mean(red11),lwd=4,col="skyblue")
```
_The residual plot shows the residuals are randomly distributed but mean value also below 0 which could be regarded as a flaw._  

### random slope
```{r,message=FALSE,warning=FALSE}
### m2
m2<-glmer(result~location+shotnumber+shotclock+dribble+touch+type+range+defence+
          dribble*touch+type*range+(touch-1|name), 
          data=da,family = binomial(),REML = T)
```
_Second model i apply is mutilevel level with random slope. In this model, different player would has different range slope._    
```{r}
### summary
summary(m2)
```
_This time, two interaction variables are introduced in the model and i define a random slope mutilevel model. The slope of the range could vary from players.From model2 we can see the most coefficients's p-value are quite small and they are significant, the AIC and BIC are 154590.2 and 154706.2. We could see the range preference could be different because some players(like Lilard) prefer to shoot long distance ball. Additionally, random effect exist between players and shooting range._  

```{r}
### check
pred2 = predict(m2,type = "link")
red2 = as.numeric(as.character(pred2))-da$result
com2 = data.frame(obs = da$result,pre = pred1) %>% pivot_longer(cols = 1:2,names_to = "type",values_to = "value")
red22 = sample(red2,4000)
### check visualization
car::qqPlot(red22)
plot(red22)+abline(h=0,lwd=4,col="skyblue")
```
_The residual plot shows the residuals are randomly distributed but mean value below 0. The qq-plot indicate the residual do not has more information. The model fits well in this way._   

### random slope and random intercept
```{r, warning=FALSE, message=FALSE}
### m3
m3<-glmer(result~location+shotnumber+shotclock+dribble+touch+type+range+defence+
          dribble*touch+type*range+(1+range|name), 
          data=da,family = binomial(),REML = T)
```
_Last model i apply is mutilevel level with random intercept and slope. In this model, different player would has different intercept and different range slope._  
```{r}
### summary
summary(m3)
```
_From model3 we can see the most coefficients's p-value are quite small and they are significant. I set players name as pooling principle,and the slope of range varys form different players, the intercept could vary for different players. We could see the range preference could be different because some players(like Lilard) prefer to shoot long distance ball. Additionally, there exists corelationships between these variables._     
```{r}
### check
pred3 = predict(m3,type = "link")
red3 = as.numeric(as.character(pred3))-da$result
com3 = data.frame(obs = da$result,pre = pred1) %>% pivot_longer(cols = 1:2,names_to = "type",values_to = "value")
red33 = sample(red3,4000)
### check visualization
car::qqPlot(red33)
plot(red33)
```
_The qq-plot and residual plot shows the residuals are randomly normal distributed, while the mean of residual turn to be -1 which henders model's effectiveness._      

## 5.4 Model evaluation and selection
```{r}
anova(m2,m3,m1)
```
_From the anova test we can see the difference between three model are slight. Nonetheless, according to AIC and BIC, the model3 is quite small so we can regard this as a better model. Hence, model 3 has more perfect performance in predicting shooting result._  

# 6.Result and discussion
## 6.1 Result    
* The analysis i present in this report does good to predict a player's shooting performance during the game. From the glm model we could see a player could be influenced by various elements, such as shooting distance, defending distance, touch time, dribble number, and the like. After we pooling the players issue, we could see there exists slightly relationship between players and shooting distance/touch time/dribbles number.

## 6.2 Limitation      
* We all know the internal relations, mood, and other potential factors might impact the shooting result, these factors are differ from places and difficult to track.   
* Regular season is quite different with the off season. Some team probably play less agressive in regular season because the risk of losing a single game is low. But when it comes to the play offs, all teams would spare no effort to chasing the championship, so some strategies might change.   

## 6.3 Improvement    
* The defensive strength could vary from teams, some teams has many tall players(LA Lakers), so teams are consist of low players(Portland Trail Blazers). Some information about opponents could largely improve the analysis quality.  
* Players are easily to get injured during games and might absent several games if injured. They need time to go back to former condition after recovery. If more information could be collected, the analysis would be more accurate.  
* NBA has the trading market machanism before a new season start, so each team’s player could vary through years, how to organize each player’s data needs to think again.

### 6.4 Future direction  
* Some other method could be added into this analysis such as statistical learning to make this analysis more strengthful. Additionally, this analysis could be used into sports field(not limited to NBA), NFL, FIFA, hockey, and the like.      

# 7.Reference website
* https://www.kaggle.com/  
* http://www.stat-nba.com/  
* https://www.basketball-reference.com/  
* https://www.hupu.com/  
* https://blog.csdn.net/  

# 8.Appendix
## shooting period preference  
```{r,echo=FALSE}
### count number
a <- count(da,period)  
### adding vectors 
period <- c('1','2','3','4','5','6','7') 
number <- c(31307,28390,30024,26038,797,149,39)
### pieplot
piepercent<- paste(round(100*number/sum(number), 2), "%")
pie(number,labels=piepercent,col= c("skyblue","lightgreen","pink","lavender","lightyellow","lightgrey"),
    radius = 0.85,border="brown",lty=6,main='Shooting period proportion')
legend("topright",period,cex=0.5,fill=c("skyblue","lightgreen","pink","lavender","lightyellow","lightgrey"))
```









